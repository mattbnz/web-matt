---
title: "Designing a PCBA friendly CO2 monitor"
date: 2023-06-22T14:36:12+12:00
draft: true

categories:
  - Technology
---

A ventilation monitoring business requires ventilation monitors to provide data. None of the existing commercial options matched the feature set I wanted co2mon.nz to deliver, so I've been personally building monitors based off Oliver Seiler's open source design. This is unsustainable, so as part of my research into the feasiblity of further developing co2mon.nz I set out to design a CO2 monitor for which I could outsource the production.



# Goals

The primary aim for redesigning the CO2 monitor is to enable production to be outsourced as much as possible. In particular that means that the PCB needs to be suitable for automated assembly (PCBA).

The secondary aim is to improve the aesthetics and design of the monitor while retaining the unique feature of displaying clear visual indication of the current ventilation level through coloured lights.

Combined, success would be a visually attractive CO2 monitor which takes less than 10 minutes per monitor to assemble/box/ship and whose production cost has the potential to be lower than the current model.

## PCB

### Design

KiCad is a wonderful open source software tool that is more than capable of handling the design of a relatively simple board such as this. I have not really done any circuit design or layout since my university days, but with the help of the online documentation and using Oliver's original as a worked example it was not too hard to get started.

The first step is to create the schematic of the electrical circuits which involves choosing which components will be used and how they will connect together. The fundamentals of the monitor remain unchanged using an ESP32 chipset with the SCD40 sensor, an SSD1306 LCD display and neopixel RGH LEDs, but with a few minor changes and additions:
* The key and most important change is a move away from using the ESP32 "devkit" boards, which are large through hole components, to instead directly using an ESP32 module with integrated antenna which can be placed as an SMD component during automated assembly. The original ESP32 base model used on the devkit boards is no longer commonly available, so the ESP32-S3-WROOM1-N4 module is my choice as the equivalent replacement.
* I added an additional temperature/humidity sensor (SHT30) with the intention of improving the accuracy of the temperature/humidity measurements the monitor provides. The current devices utilise temperature/humidity measurements taken by the SCD40 chipset which are primarily taken and used for its calculation of CO2 levels and rely on an offset being subtracted to account for the heat generated by the electronic components themselves. I've found it to be OK, but not perfect. SHT30 is a cheap part, so its addition to give an improved temperature/humidity measurement is an easy choice.
* I swapped to USB-C instead of USB-B for the power connector. USB-C is much more commonly available these days and is also smaller and not as tall off the board which provides more flexibility in the case design. The distance between the pads/pins of the connector on the board is much narrower than with USB-B which required some careful design in the routing stage, but ultimately worked fine with no bridging or short circuit issues experienced so far.
* I also kept the BME680 sensor which provides barometric pressure and VOC measurements. This is an optional component also present in the design of the current monitors which I have not been including in the builds so far but seems useful to keep and retain as an option. In addition to the utility of the VOC measurement itself (highly requested in the survey results) the barometric pressure can be fed into the SCD40 sensor to provide automatic calibration of its measurements without having to manually configure the altitude the sensor is located at.

With those major components selected and placed on the schematic the major remaining work is to add the supporting circuitry required for each component, including the power supply. The majority of this is based on the reference design from the ESP32 datasheet, with further help on the USB-C power supply resistor sizing and regulation from XXX.

The end result is a relatively straightforward schematic (click the image to enlarge).

[![Schematic](schematic.png?width=350px#float-end)](schematic.png)  From the logical representation on the schematic, the next step is to begin physically laying out the components on the PCB itself which requires first determining the overall size, shape and outline of the board. This step happens very much in iteration with the initial case design, as obviously the size/shape and layout of components of the PCB is heavily influenced and constrained by how the final assembled monitor in its case is desired to look and function.

The layout is not purely driven by the aesthetic outcome however as the components themselves also have considerations that must be taken into account, including:
* For best WiFi reception, the ESP32 antenna should be at the top of the monitor and should not have PCB underneath it, or for a specified distance either side of it.
* The SHT30 temperature sensor should be as far from any heat generating components (e.g. the ESP32, BME680 and SCD40 modules) as possible and also considering that any generated heat will rise, as low on the monitor as possible.
* The sensors measuring the air (SCD40, BME680 and SHT30) must have good exposure to the air outside the case.

Taking all of these factors into account I ended up with a square PCB containing a cutout in the top right so that the ESP32 antenna can sit without the overall square outline while still meeting its design requirements. The SCD40 and BME680 sit in the top left corner, near the edges for good airflow and far away from the SHT30 temperature sensor in the bottom left corner. The LEDs I placed in a horizontal row across the center of the board, the LCD in the bottom right, a push button on the right-hand side and the USB-C socket in the center at the bottom.

Alongside the placement of the component, the other big job at this stage is to route the traces (aka wires) between the components on the board such that all the required electrical connections are made without any unintended connections (aka shorts) being created. This is a fun constraint solving/optimisation challenge and takes on an almost artistic aspect with other PCB designers often having strong opinions on which layout is best. The majority of the traces and routing for this board were able to be placed on the top layer of the PCB, but I also made use of the back layer for a few traces to help avoid conflicts and deal with places where different traces needed to cross each other. It's easy to see how this step would be much more challenging and time consuming on a larger and more complex PCB design.

The final touches were to add some debugging breakouts for the serial and JTAG ports on the ESP32-S3 in case the USB connection did not function reliably for any reason, as well as for the I2C bus on the off-chance that I later decided to add another component alongside the monitor. Finally a logo and various other helpful text to be added to the silkscreen layer and printed on the PCB so it looks nice.

### Production

For assembly of the PCB, I went with JLCPCB based out of China, the process was amazingly quick with the completed PCBs arriving within 7 days of the order being placed. The trickiest part of the process was component selection and ensuring that the parts I had planned in the schematic were available for assembly at JLCPCB. I found the https://github.com/bouni/kicad-jlcpcb-tools plugin for KiCad to be invaluable for this. The search interface it provides is fairly clunky and I found it was often easier to search for the part I needed on lcsc.com and then just copy the part number across into the plugin's search box initially rather than trying to search by name or component type.

Unfortunately the most crucial part, the SCD40 sensor, is not stocked at all by lcsc.com! To work around this JLCPCB will maintain a personal component library for you which you can ship stock to them to for use in future orders. Given that the SCD40 is the most delicate and expensive part on the boards currently, and I already have plenty in stock here for my previous builds I chose not to do this for the initial runs, so I ordered the boards to be assembled without the SCD40.

The LCD screen is the remaining component which is not easily assembled onto the PCB directly, but as you'll see next, this actually turned out to be OK as integrating the screen directly into the case makes the final assembly process smoother.

The final surprise in the assembly process was the concept of edge rails, additional PCB that is attached on either side of the board to help with feeding it through the assembly machine in the correct position. These are added automatically by JLCPCB and have to be snapped off after the completed boards are received. I hadn't heard about these before and I was a little worried that they'd interfere or get in the way of either the antenna cut-out at the top of the board, or the switch on the right hand side as it overhangs the edge so it can sit flush with the case. This concern was also a factor in choosing not to get the expensive components (SCD40, BME680) populated on the initial boards. Despite my concerns there were no issues with edge rails, the switch was placed hanging over them without issue and snapping them off once the boards arrived was a trivial 30s job using a vice to hold the edge rail and then gently tipping the board over until it snapped off - the interface between the board and the rails while solid looking has obviously been scored or perforated in some way during the production process so the edge breaks cleanly and smoothly. Magic!

## Case

### Design

I mocked up a very simple prototype of the case in FreeCAD during the PCB design process itself to help position and align the placement of the screen, switch and USB socket on the PCB as all three of these components interface directly with the edges of the case. Initially this design was similar to the current monitor design where the PCB (with lights and screen attached) sits in the bottom of the case, which has walls containing grilles for airflow and then a separate transparent perspex is screwed onto the top to complete the enclosure.

As part of the aesthetic improvements for the new monitor I wanted to move away from a transparent led to something more opaque but still translucent enough to allow the colour of the lights to show through and therefore because the lid would no longer be transparent to mount the LCD directly into the case itself.

The first few iterations of prototype were a struggle to get the cover to attach nicely to the LCD on the PCB - to stay in place the LCD has to be pushed over some mounting poles with a little catch on the back of the cover, which requires a moderate amount of force, and applying that force to the smaller LCD board if it is already connected to the PCB is essentially impossible.

As a result I ended up completely flipping the design such that the cover is a single piece of plastic that also encompasses the walls of the case and contains appropriate mounting stakes for both the screen and the main PCB. Getting to this design hugely simplified the assembly process. Starting with an empty case (cover + walls) lying face down on a bench, the LCD screen is pushed onto it's mounting poles and sits flush with the cover of the case - easily achieved without the main PCB yet in place. Next, the main PCB is gently lowered into the case facing downwards, and having iterated through getting the dimensions and positioning just right sits cleanly over 4 mounting poles in each corner, and also the pins connecting the LCD which just protrude through the appropriate holes in the PCB. At this point, the 4 pins can be quickly soldered into place. Finally, a back panel can be attached which holds the PCB in place and uses ["cantilever snap joints"](https://fab.cba.mit.edu/classes/S62.12/people/vernelle.noel/Plastic_Snap_fit_design.pdf) to click on to the rest of the case.

Overall the design is a huge improvement over the previous case which required screws and spacers to position the PCB and cover relative to the rest of the case, with the spacers and screws being particularly fiddly to work with. The major concern I had with the new design was that the mount to attach the monitor to the wall has moved from being attached to the main case and components directly to needing to be on the removable back panel - if the clips holding this panel to the case fail the core part of the monitor will fall off the wall which would not be good. To guard against this I've doubled the size and number of clips at the top of the case (which bears the weight) and the result seems very robust in my testing. To completely assemble a monitor, including the soldering step takes me about 2-3 minutes individually, and would be even quicker if working in batches.

### Production

I've successfully used JLCPCB's 3D printing service for the previous case design, so given the number of design/testing iterations required to fine tune the case I chose not to outsource case production for now and used my 3D printer to produce them. I'm confident that getting sufficient cases printed from JLCPCB or another supplier again will not be a much issue now that the design is finalised.

I tried a variety of filament colours, but settled on a transparent filament which once combined in the necessary layers to form the case is not actually transparent like perspex is, but provides a nice translucent medium which achieves the goal of having the light colour visible without exposing all of the circuit board detail. There's room for future improvement in the positioning of the LEDs on the circuit board to provide a more even distribution of light across the case, and the red power LED that I included in the design turns out to be more of an annoyance/distraction than being useful, but overall I really like the way the completed monitor ends up looking.

## Evaluation

Building this monitor has been a really fun project, both in seeing something progress from an idea, to plans on a screen to a nice physical thing on my wall, but also in learning and developing a bunch of new skills in PCB design, assembly and 3D design.

The goal of having a CO2 monitor which I can outsource the vast majority of production of looks to be well in hand (equivocating here only because I haven't actually done it in volume yet!) and the final assembly steps are quick, easy and well below the level of effort and time it was taking me to produce the original monitors.

As fun as this has been, it's also given me a much better appreciation for how much I'm only just scratching the surface of the potential complexities and challenges in producing a hardware product like this. I'm pretty confident I could use this design and process to successfully produce a few hundred and maybe even a few thousand monitors, but it's also clear that getting beyond that point is and would be a whole further level of effort and learning. Hardware is hard work. It's not really a revelatory discovery, but there is something to be said for experiencing the process first hand to make the reality of what's required real.